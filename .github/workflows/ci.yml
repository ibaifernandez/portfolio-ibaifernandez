# ──────────────────────────────────────────────────────────────────────────────
# ci.yml — Pipeline completo: quality gates → build → E2E → deploy
#
# Flujo:
#   Push a cualquier rama  → quality + build + E2E (sin deploy)
#   Push a main            → quality + build + E2E → deploy a producción
#   Pull Request           → quality + build + E2E → deploy preview
#
# Secrets requeridos en GitHub → Settings → Secrets → Actions:
#   NETLIFY_AUTH_TOKEN   Personal access token de Netlify (User settings → OAuth)
#   NETLIFY_SITE_ID      Site ID del proyecto (Netlify → Site configuration → General)
# ──────────────────────────────────────────────────────────────────────────────

name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  quality-build-e2e:
    name: Quality · Build · E2E
    runs-on: ubuntu-latest

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── Node ─────────────────────────────────────────────────────────────
      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ── Dependencias del sistema ─────────────────────────────────────────
      # ripgrep lo usa quality-guards.sh internamente
      - name: Install system dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y ripgrep

      # ── Dependencias npm (incluye resend para las Functions) ─────────────
      - name: Install dependencies
        run: npm ci

      # ── Build ─────────────────────────────────────────────────────────────
      # Genera los HTML finales desde src/ + content/ antes de cualquier test.
      # Los E2E sirven estos ficheros ya compilados.
      - name: Build pages
        run: npm run build:pages

      # ── Quality guards ────────────────────────────────────────────────────
      # Incluye: estructura, seguridad, a11y baseline, performance budget,
      # cobertura AVIF/WebP y checker de links internos.
      - name: Quality guards
        run: npm run test:quality

      # ── Playwright ────────────────────────────────────────────────────────
      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: E2E tests
        run: npm run test:e2e

      # ── Artefactos de test ───────────────────────────────────────────────
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          if-no-files-found: ignore

      # ── Deploy a producción (solo main, solo push) ───────────────────────
      # Despliega los ficheros ya construidos + las Functions bundleadas.
      # Netlify CLI respeta .netlifyignore, así que no sube src/, scripts/, etc.
      # Prerrequisito: deshabilitar auto-deploy en Netlify (ver README de deploy).
      - name: Deploy to Netlify (production)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          npx netlify-cli@latest deploy \
            --prod \
            --dir . \
            --message "Deploy ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # ── Deploy preview (PRs) ─────────────────────────────────────────────
      - name: Deploy preview to Netlify
        if: github.event_name == 'pull_request'
        run: |
          DEPLOY_URL=$(npx netlify-cli@latest deploy \
            --dir . \
            --json \
            --message "Preview PR #${{ github.event.pull_request.number }}" \
            | jq -r '.deploy_url')
          echo "Preview URL: $DEPLOY_URL"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
